package com.shaw.lenoadmin.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.shaw.lenoadmin.param.UserLoginParam;
import com.shaw.lenoadmin.util.JWTUtil;
import com.shaw.lenoadmin.util.PWDUtil;
import com.shaw.lenoadmin.vo.CaptchaVo;
import com.shaw.lenoadmin.mapper.UserMapper;
import com.shaw.lenoadmin.pojo.UserPojo;
import com.shaw.lenoadmin.service.UserService;
import com.shaw.lenoadmin.util.Result;
import com.shaw.lenoadmin.vo.UserLoginVo;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Service
@Slf4j
public class UserServiceImpl extends ServiceImpl<UserMapper, UserPojo> implements UserService {
    static final String VERIFY_CODE_VALUE = "10";

    /**
     * 获取验证码信息
     * TODO: 真实的验证码
     *
     * @return
     */
    @Override
    public Result<CaptchaVo> captcha() {
        CaptchaVo captchaVo = new CaptchaVo("8chlz3tgqivwhc008ijs8dvi35v6j9", "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"120\" height=\"46\" viewBox=\"0,0,120,46\"><rect width=\"100%\" height=\"100%\" fill=\"#cc9966\"/><path fill=\"#575556\" d=\"M89.29 24.91L89.31 24.94L89.36 24.98Q90.06 24.97 91.32 24.83L91.21 24.72L91.29 24.80Q91.33 25.46 91.33 26.04L91.24 25.95L91.21 27.04L91.19 27.01Q90.53 27.10 89.78 27.17L89.80 27.19L89.68 27.07Q88.99 27.16 88.24 27.13L88.23 27.12L88.31 27.20Q85.79 32.73 82.73 36.85L82.73 36.85L82.70 36.82Q80.47 37.40 79.31 37.95L79.20 37.83L79.32 37.96Q83.00 32.86 85.72 27.25L85.63 27.17L83.27 27.15L83.32 27.20Q83.32 26.01 83.22 24.82L83.12 24.72L83.15 24.75Q84.82 24.86 86.65 24.86L86.63 24.84L88.41 21.62L88.37 21.57Q89.25 19.88 90.34 18.45L90.34 18.45L90.45 18.56Q89.09 18.73 87.67 18.73L87.56 18.63L87.48 18.55Q82.05 18.56 78.69 16.59L78.69 16.59L78.27 15.22L78.19 15.14Q77.98 14.48 77.64 13.70L77.63 13.70L77.64 13.71Q81.51 16.05 86.61 16.25L86.62 16.26L86.59 16.23Q91.04 16.30 95.63 14.53L95.74 14.63L95.80 14.70Q95.60 15.04 95.16 15.82L95.04 15.71L95.14 15.80Q91.96 20.10 89.41 25.03ZM96.57 17.03L96.47 16.93L97.34 15.12L97.40 15.18Q96.64 15.71 95.14 16.35L95.03 16.24L95.30 16.07L95.22 15.99Q95.41 15.94 95.51 15.84L95.40 15.73L95.52 15.85Q95.77 15.14 96.41 13.95L96.51 14.05L96.37 13.91Q91.71 16.05 86.58 15.84L86.61 15.88L86.51 15.78Q81.14 15.53 76.89 12.88L76.86 12.85L76.88 12.87Q77.88 14.63 78.63 17.00L78.63 17.01L78.64 17.02Q79.64 17.60 80.35 17.88L80.27 17.79L80.23 17.76Q80.37 18.07 80.78 19.73L80.86 19.81L80.81 19.76Q83.65 20.91 88.58 20.77L88.51 20.70L88.66 20.85Q88.21 21.18 86.44 24.55L86.61 24.71L86.55 24.65Q84.77 24.71 83.00 24.54L82.94 24.48L82.98 24.52Q82.91 25.12 82.91 25.90L83.08 26.08L83.06 27.59L84.44 27.47L84.41 28.69L84.42 28.71Q80.90 35.28 78.41 38.48L78.53 38.59L78.42 38.48Q79.99 37.94 81.45 37.50L81.37 37.42L81.47 37.52Q80.71 38.19 79.48 39.72L79.66 39.89L79.60 39.83Q82.42 38.84 84.59 38.64L84.56 38.60L84.50 38.55Q87.25 35.31 90.03 29.26L89.88 29.10L93.11 29.44L93.01 29.35Q92.96 28.55 92.96 27.73L92.99 27.76L92.90 26.08L93.00 26.17Q92.67 26.08 92.17 26.11L92.16 26.10L92.26 26.20Q91.65 26.12 91.41 26.12L91.46 26.16L91.53 26.24Q91.50 26.10 91.53 25.97L91.43 25.86L91.52 25.71L91.61 25.81Q93.72 21.08 96.47 16.93Z\"/><path fill=\"#614c4c\" d=\"M57.63 35.85L57.62 35.85L57.71 35.94Q56.99 35.79 56.38 35.83L56.53 35.98L56.38 35.83Q55.81 35.98 55.20 35.98L55.29 36.07L55.12 35.89Q55.57 32.87 55.57 29.81L55.68 29.93L55.56 29.80Q53.99 29.90 53.17 29.90L53.12 29.85L53.18 29.91Q52.37 29.85 50.74 29.78L50.70 29.74L50.83 29.87Q50.89 29.66 50.72 27.45L50.56 27.29L50.62 27.35Q52.99 27.92 55.64 27.92L55.56 27.84L55.53 27.81Q55.27 23.84 54.89 21.53L54.98 21.62L55.01 21.65Q55.78 21.80 56.50 21.80L56.47 21.78L57.84 21.69L57.80 21.65Q57.73 25.59 57.73 27.90L57.61 27.78L57.73 27.90Q59.61 27.84 62.47 27.54L62.46 27.53L62.53 27.60Q62.40 28.76 62.40 29.85L62.26 29.71L62.31 29.76Q62.16 29.85 61.45 29.88L61.41 29.84L61.38 29.82Q60.55 29.87 60.01 29.90L59.89 29.79L59.89 29.78Q59.96 29.85 57.58 29.85L57.50 29.77L57.59 32.92L57.67 33.00Q57.54 34.34 57.64 35.87ZM62.78 27.04L62.81 27.07L62.84 27.10Q61.13 27.35 59.46 27.42L59.49 27.45L59.52 27.48Q59.60 24.54 59.98 22.87L60.09 22.99L60.06 22.96Q59.37 22.94 58.11 23.08L58.27 23.23L58.29 21.26L58.36 21.32Q56.06 21.37 54.57 21.27L54.44 21.14L54.45 21.15Q55.12 24.10 55.29 27.56L55.21 27.49L55.22 27.49Q53.64 27.44 50.34 26.90L50.26 26.82L50.28 26.84Q50.47 27.85 50.47 30.19L50.54 30.26L51.98 30.34L51.79 30.15Q51.91 30.91 51.77 32.17L51.79 32.19L55.21 31.84L55.33 31.95Q55.16 34.82 54.89 36.45L54.81 36.36L54.81 36.37Q55.47 36.35 56.73 36.25L56.77 36.29L56.80 36.32Q56.66 36.79 56.63 37.98L56.78 38.13L56.80 38.15Q57.13 38.01 60.36 38.14L60.40 38.18L60.49 38.27Q59.64 35.48 59.43 31.95L59.37 31.89L59.34 31.85Q62.32 31.94 64.18 32.28L64.21 32.31L64.23 32.32Q64.05 31.46 64.05 30.61L64.08 30.65L63.97 28.84L63.96 28.83Q63.94 29.01 63.46 29.04L63.41 29.00L62.67 28.97L62.64 28.93Q62.67 28.25 62.77 27.02Z\"/><path fill=\"#505557\" d=\"M23.96 36.70L23.97 36.71L23.97 36.71Q22.70 36.77 21.31 36.39L21.39 36.47L21.33 36.41Q20.20 35.55 20.06 34.09L20.07 34.10L20.02 34.05Q20.07 33.97 20.24 31.62L20.15 31.53L20.22 31.60Q21.10 31.39 22.90 31.05L22.95 31.10L22.85 31.85L22.70 31.70Q22.59 33.39 23.85 33.90L23.83 33.89L23.76 33.81Q24.44 34.09 26.31 34.09L26.47 34.24L26.36 34.14Q27.82 34.03 27.99 33.97L27.98 33.95L28.03 34.00Q28.72 33.74 29.36 33.30L29.39 33.33L29.52 33.46Q30.67 32.50 30.50 30.63L30.47 30.60L30.48 30.61Q30.36 28.48 28.81 27.09L28.78 27.05L28.81 27.08Q27.22 25.65 25.01 25.65L25.11 25.75L25.07 25.50L25.14 25.57Q25.35 25.41 26.13 25.34L26.10 25.31L26.22 25.43Q27.84 25.25 29.06 24.14L29.02 24.10L29.03 24.11Q30.30 23.05 30.43 21.38L30.37 21.32L30.55 21.50Q30.54 21.12 30.54 20.82L30.50 20.77L30.56 20.83Q30.43 19.34 29.20 18.52L29.29 18.61L29.23 18.55Q28.14 17.84 26.71 17.94L26.71 17.93L26.78 18.00Q25.61 17.85 24.52 18.22L24.54 18.25L24.54 18.25Q23.23 18.70 22.95 19.72L22.89 19.65L22.96 19.72Q22.77 20.39 22.84 21.07L22.86 21.08L22.79 21.01Q21.94 20.88 20.11 20.24L20.16 20.29L20.16 20.29Q19.82 18.66 19.86 17.91L19.95 18.01L19.94 18.00Q20.09 16.69 21.04 16.07L20.98 16.01L21.01 16.04Q22.18 15.41 23.61 15.41L23.69 15.49L23.72 15.52Q26.42 15.37 29.24 15.60L29.39 15.75L29.29 15.66Q33.86 16.07 33.59 19.44L33.52 19.37L33.67 19.52Q33.60 20.85 33.16 22.24L33.10 22.18L33.11 22.19Q32.18 24.83 30.07 25.64L30.21 25.78L30.20 25.78Q32.44 26.14 32.98 29.14L33.01 29.16L32.99 29.14Q33.17 30.13 33.23 31.93L33.32 32.02L33.27 31.97Q33.40 35.94 29.28 36.34L29.34 36.41L29.39 36.45Q28.74 36.51 24.01 36.75ZM28.61 38.70L28.52 38.61L28.63 38.71Q29.11 38.69 31.66 38.76L31.65 38.75L31.73 38.83Q33.27 38.87 34.73 38.29L34.66 38.22L34.73 38.29Q35.74 37.39 35.57 35.83L35.69 35.96L35.72 35.98Q35.44 34.62 35.17 33.05L35.21 33.10L35.28 33.16Q34.65 29.17 32.91 27.71L32.79 27.58L32.79 27.41L32.73 27.32L32.65 27.24Q34.24 25.97 34.92 22.06L34.88 22.02L34.93 22.08Q35.01 21.72 35.12 20.87L35.02 20.77L35.06 20.81Q35.02 20.02 34.95 19.41L34.99 19.45L34.99 19.45Q34.91 18.01 33.76 17.40L33.83 17.47L33.75 17.46L33.67 17.38Q33.33 16.43 32.31 15.95L32.37 16.01L32.43 16.07Q31.07 15.47 26.49 15.19L26.47 15.18L26.43 15.14Q24.90 15.04 23.47 15.04L23.61 15.17L23.42 14.98Q22.12 15.11 20.76 15.69L20.73 15.66L20.77 15.70Q19.55 16.25 19.55 17.81L19.62 17.88L19.59 17.84Q19.57 17.45 19.80 20.44L19.96 20.60L19.82 20.46Q20.25 20.68 21.71 21.23L21.70 21.21L21.55 21.07Q21.64 21.63 21.60 22.07L21.53 22.00L21.63 22.10Q21.60 22.51 21.63 22.98L21.52 22.87L21.58 22.94Q23.28 23.38 25.09 23.48L24.93 23.33L25.01 23.41Q24.97 21.63 25.96 20.88L25.91 20.83L26.01 20.94Q26.65 20.25 28.45 20.05L28.57 20.17L28.57 20.17Q29.55 20.13 30.06 20.30L30.02 20.25L29.95 20.19Q29.98 20.28 30.01 20.38L30.12 20.49L30.17 20.72L30.15 21.10L30.18 21.13Q30.09 21.21 30.06 21.35L30.21 21.50L30.09 21.38Q30.11 23.00 28.75 24.06L28.70 24.00L28.62 23.92Q27.93 24.86 26.13 25.03L26.14 25.05L26.15 25.06Q25.49 25.18 24.71 25.18L24.75 25.22L24.73 25.20Q24.68 25.42 24.82 26.03L24.94 26.16L24.79 26.01Q26.37 26.02 27.66 26.67L27.60 26.61L27.69 26.80L26.30 26.97L26.21 26.88Q26.22 27.17 26.32 27.71L26.27 27.66L26.31 27.69Q28.25 27.66 29.78 28.85L29.86 28.93L29.84 28.91Q29.94 29.15 30.21 30.61L30.18 30.58L30.31 30.71Q30.50 33.35 27.89 33.73L27.86 33.70L27.75 33.59Q25.89 33.84 25.38 33.80L25.49 33.91L25.36 33.79Q25.04 33.77 24.57 33.70L24.54 33.67L24.63 33.36L24.58 32.80L24.61 32.45L24.62 32.16L24.67 32.21Q23.93 32.38 23.21 32.55L23.10 32.44L23.07 32.41Q23.03 32.20 23.03 32.03L23.06 32.06L23.13 32.13Q23.18 31.97 23.18 31.77L23.10 31.70L23.15 31.74Q23.09 31.27 23.22 30.62L23.35 30.75L23.28 30.68Q21.73 31.00 20.07 31.31L20.04 31.28L19.91 31.15Q19.89 31.58 19.79 32.58L19.86 32.65L19.82 32.61Q19.85 33.75 19.85 34.29L19.77 34.21L19.76 34.20Q19.79 36.00 21.02 36.68L21.08 36.74L21.09 36.75Q22.33 38.70 26.54 38.53L26.69 38.68L26.67 38.66Q27.35 38.66 28.71 38.80Z\"/><path d=\"M16 18 C67 44,57 24,104 33\" stroke=\"#edb277\" fill=\"none\"/></svg>");
        return Result.ok(captchaVo);
    }

    /**
     * 用户登录
     * TODO: 校验真实的验证码
     *
     * @param param
     * @return
     */
    @Override
    public Result<UserLoginVo> login(UserLoginParam param) {
        // 校验验证码
        if (!VERIFY_CODE_VALUE.equals(param.getCode())) {
            return Result.fail(400, "输入的验证码错误");
        }

        QueryWrapper<UserPojo> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("user_name", param.getUserName());

        UserPojo user = getOne(queryWrapper);
        if (user == null) {
            return Result.fail(400, "用户名或密码错误");
        }

        boolean isCompare = PWDUtil.compare(param.getPassword(), user.getPassword());
        if (!isCompare) {
            return Result.fail(400, "用户名或密码错误");
        }

        String token = JWTUtil.createToken(user);

        return Result.ok("用户登录成功", new UserLoginVo(token));
    }


}
